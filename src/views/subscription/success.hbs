{{#> layouts/main}}

<div class="subscription-success">
  <div class="success-container">
    <div class="success-icon">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22,4 12,14.01 9,11.01"></polyline>
      </svg>
    </div>
    
    <h1>Welcome to {{capitalize subscription.tier}}!</h1>
    <p class="success-message">Your subscription has been activated successfully. You now have access to all {{capitalize subscription.tier}} features.</p>
    
    <div class="subscription-details">
      <div class="detail-card">
        <h3>What's Next?</h3>
        <div class="next-steps">
          <div class="step">
            <div class="step-number">1</div>
            <div class="step-content">
              <h4>Start Amplifying Videos</h4>
              <p>Upload your first video and let our AI create summaries, titles, and more.</p>
            </div>
          </div>
          
          <div class="step">
            <div class="step-number">2</div>
            <div class="step-content">
              <h4>Connect YouTube</h4>
              <p>Link your YouTube channel to import and process existing videos.</p>
            </div>
          </div>
          
          {{#if subscription.featureFlags.analyticsAccess}}
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-content">
              <h4>View Analytics</h4>
              <p>Track your content performance with advanced analytics dashboard.</p>
            </div>
          </div>
          {{/if}}
        </div>
      </div>
      
      <div class="detail-card">
        <h3>Your Plan Includes</h3>
        <div class="plan-features">
          {{#each subscription.features}}
          <div class="feature-item">
            <svg class="check-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span>{{this}}</span>
          </div>
          {{/each}}

          {{#if subscription.featureFlags.analyticsAccess}}
          <div class="feature-item">
            <svg class="check-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span>Advanced Analytics Dashboard</span>
          </div>
          {{/if}}

          {{#if subscription.featureFlags.apiAccess}}
          <div class="feature-item">
            <svg class="check-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span>API Access for Custom Integration</span>
          </div>
          {{/if}}
        </div>
      </div>
    </div>
    
    <div class="action-buttons">
      <a href="/videos/upload" class="btn btn-primary btn-large">
        <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        Start Amplifying Videos
      </a>
      
      <a href="/subscription" class="btn btn-secondary">View Dashboard</a>
    </div>
    
    {{#if sessionId}}
    <div class="receipt-info">
      <p>Need a receipt? <a href="#" id="view-receipt-link">View your receipt</a></p>
    </div>
    {{/if}}
  </div>
</div>

<div id="notification-container" class="notification-container"></div>

<script>
  // Track Purchase event for successful subscription
  document.addEventListener('DOMContentLoaded', function() {
    // Meta/TikTok Pixel tracking
    if (typeof trackPurchase === 'function') {
      trackPurchase({
        content_name: '{{capitalize subscription.tier}} Plan',
        content_id: '{{subscription.tier}}',
        content_type: 'subscription',
        value: {{#if subscription.priceAmount}}{{subscription.priceAmount}}{{else}}0{{/if}},
        currency: '{{#if subscription.priceCurrency}}{{subscription.priceCurrency}}{{else}}USD{{/if}}'
      });
    }

    // Google Ads Conversion Tracking
    if (typeof gtag === 'function') {
      // Google Ads conversion
      gtag('event', 'conversion', {
        'send_to': 'AW-17881586055/A3lMCJTZ3uobEIezzc5C',
        'value': {{#if subscription.priceAmount}}{{subscription.priceAmount}}{{else}}1.0{{/if}},
        'currency': '{{#if subscription.priceCurrency}}{{subscription.priceCurrency}}{{else}}USD{{/if}}',
        'transaction_id': '{{#if sessionId}}{{sessionId}}{{/if}}'
      });

      // GA4 purchase event (for analytics attribution)
      gtag('event', 'purchase', {
        'transaction_id': '{{#if sessionId}}{{sessionId}}{{/if}}',
        'value': {{#if subscription.priceAmount}}{{subscription.priceAmount}}{{else}}1.0{{/if}},
        'currency': '{{#if subscription.priceCurrency}}{{subscription.priceCurrency}}{{else}}USD{{/if}}',
        'items': [{
          'item_name': '{{#if subscription.tier}}{{capitalize subscription.tier}} Plan{{else}}Subscription{{/if}}',
          'item_category': 'subscription',
          'price': {{#if subscription.priceAmount}}{{subscription.priceAmount}}{{else}}1.0{{/if}},
          'quantity': 1
        }]
      });
    }
  });

  // Notification system to replace alerts
  function showNotification(message, type = 'info', duration = 5000) {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <div class="notification-content">
        <span class="notification-message">${message}</span>
        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
      </div>
    `;
    
    container.appendChild(notification);
    
    // Auto-remove after duration
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, duration);
  }

  {{#if sessionId}}
  // Handle receipt viewing
  document.getElementById('view-receipt-link')?.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      const response = await fetch('/api/subscription/receipt?session_id={{sessionId}}');
      const data = await response.json();
      
      if (data.success && data.receiptUrl) {
        window.open(data.receiptUrl, '_blank');
      } else {
        showNotification('Receipt not available at this time. Please check your email or contact support.', 'warning', 8000);
      }
    } catch (error) {
      console.error('Receipt error:', error);
      showNotification('Unable to retrieve receipt. Please check your email or contact support.', 'error', 8000);
    }
  });
  {{/if}}

  // Auto-redirect banner after 25 seconds
  setTimeout(() => {
    const banner = document.createElement('div');
    banner.className = 'redirect-banner';
    banner.innerHTML = `
      <div class="redirect-banner-content">
        <span>Ready to explore your dashboard?</span>
        <div class="redirect-banner-actions">
          <button onclick="window.location.href='/subscription'" class="btn btn-primary btn-small">Go to Dashboard</button>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn btn-secondary btn-small">Stay Here</button>
        </div>
      </div>
    `;
    
    document.querySelector('.subscription-success').insertBefore(banner, document.querySelector('.success-container'));
  }, 25000);
</script>

{{/layouts/main}}