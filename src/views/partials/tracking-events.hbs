{{!--
  Tracking Events Helper
  Provides functions to fire Meta and TikTok pixel events

  Usage in templates:
  1. Include this partial: {{> tracking-events}}
  2. Call tracking functions in your page's JavaScript:
     - trackEvent('ViewContent', { content_name: 'Upgrade Page', value: 29.99, currency: 'USD' })
     - trackPurchase({ value: 29.99, currency: 'USD', content_name: 'Premium Plan' })
     - trackInitiateCheckout({ value: 29.99, currency: 'USD' })
     - trackCompleteRegistration({ content_name: 'Email Signup' })
--}}

<script>
(function() {
  // Unified tracking helper
  window.AmplifyTracking = {
    /**
     * Generate unique event ID for deduplication
     * @param {string} eventType - Type of event (view, checkout, purchase, etc.)
     * @param {string} identifier - Optional unique identifier (subscription_id, tier, etc.)
     */
    _generateEventId: function(eventType, identifier) {
      var timestamp = Date.now();
      var random = Math.random().toString(36).substring(2, 8);
      if (identifier) {
        return eventType + '_' + identifier + '_' + timestamp;
      }
      return eventType + '_' + timestamp + '_' + random;
    },

    /**
     * Track a generic event on both Meta and TikTok pixels
     * @param {string} eventName - Event name (Meta standard events)
     * @param {object} params - Event parameters
     */
    trackEvent: function(eventName, params) {
      params = params || {};
      var eventId = this._generateEventId(eventName.toLowerCase(), params.content_id);

      // Meta Pixel
      if (typeof fbq === 'function') {
        fbq('track', eventName, params, { eventID: eventId });
        console.log('[Meta Pixel] Tracked:', eventName, params, 'eventID:', eventId);
      }

      // TikTok Pixel - map Meta events to TikTok equivalents
      if (typeof ttq === 'object' && ttq.track) {
        var tiktokEvent = this._mapToTikTokEvent(eventName);
        var tiktokParams = this._mapToTikTokParams(params);
        tiktokParams.event_id = eventId;
        ttq.track(tiktokEvent, tiktokParams);
        console.log('[TikTok Pixel] Tracked:', tiktokEvent, tiktokParams);
      }
    },

    /**
     * Track subscription/product purchase
     * @param {object} params - { value, currency, content_name, content_id, transaction_id }
     */
    trackPurchase: function(params) {
      params = params || {};
      var contentName = params.content_name || 'Subscription';
      var contentId = params.content_id || contentName.toLowerCase().replace(/\s+/g, '_');
      var value = params.value || 0;
      var eventId = this._generateEventId('purchase', params.transaction_id || contentId);

      // Meta Pixel - Purchase event
      if (typeof fbq === 'function') {
        fbq('track', 'Purchase', {
          value: value,
          currency: params.currency || 'USD',
          content_name: contentName,
          content_type: 'product',
          content_ids: [contentId]
        }, { eventID: eventId });
        console.log('[Meta Pixel] Purchase tracked:', params, 'eventID:', eventId);
      }

      // TikTok Pixel - CompletePayment event with contents array
      if (typeof ttq === 'object' && ttq.track) {
        ttq.track('CompletePayment', {
          value: value,
          currency: params.currency || 'USD',
          event_id: eventId,
          contents: [
            {
              content_id: contentId,
              content_type: 'product',
              content_name: contentName,
              price: value,
              quantity: 1
            }
          ]
        });
        // Also fire Subscribe event for subscription-specific tracking
        var subscribeEventId = this._generateEventId('subscribe', params.transaction_id || contentId);
        ttq.track('Subscribe', {
          value: value,
          currency: params.currency || 'USD',
          event_id: subscribeEventId
        });
        console.log('[TikTok Pixel] Purchase tracked:', params, 'eventID:', eventId);
      }
    },

    /**
     * Track when user views upgrade/pricing page
     * @param {object} params - { content_name, value, currency }
     */
    trackViewContent: function(params) {
      params = params || {};
      var contentName = params.content_name || 'Pricing Page';
      var contentId = params.content_id || contentName.toLowerCase().replace(/\s+/g, '_');
      var eventId = this._generateEventId('viewcontent', contentId);

      // Meta Pixel
      if (typeof fbq === 'function') {
        fbq('track', 'ViewContent', {
          content_name: contentName,
          content_type: 'product',
          value: params.value || 0,
          currency: params.currency || 'USD'
        }, { eventID: eventId });
        console.log('[Meta Pixel] ViewContent tracked:', params, 'eventID:', eventId);
      }

      // TikTok Pixel - use contents array format
      if (typeof ttq === 'object' && ttq.track) {
        ttq.track('ViewContent', {
          value: params.value || 0,
          currency: params.currency || 'USD',
          event_id: eventId,
          contents: [
            {
              content_id: contentId,
              content_type: 'product',
              content_name: contentName
            }
          ]
        });
        console.log('[TikTok Pixel] ViewContent tracked:', params, 'eventID:', eventId);
      }
    },

    /**
     * Track when user initiates checkout
     * @param {object} params - { value, currency, content_name, content_id }
     */
    trackInitiateCheckout: function(params) {
      params = params || {};
      var contentName = params.content_name || 'Subscription';
      var contentId = params.content_id || contentName.toLowerCase().replace(/\s+/g, '_');
      var value = params.value || 0;
      var eventId = this._generateEventId('checkout', contentId);

      // Meta Pixel
      if (typeof fbq === 'function') {
        fbq('track', 'InitiateCheckout', {
          value: value,
          currency: params.currency || 'USD',
          content_name: contentName,
          content_type: 'product',
          num_items: 1
        }, { eventID: eventId });
        console.log('[Meta Pixel] InitiateCheckout tracked:', params, 'eventID:', eventId);
      }

      // TikTok Pixel - use contents array format
      if (typeof ttq === 'object' && ttq.track) {
        ttq.track('InitiateCheckout', {
          value: value,
          currency: params.currency || 'USD',
          event_id: eventId,
          contents: [
            {
              content_id: contentId,
              content_type: 'product',
              content_name: contentName,
              price: value,
              quantity: 1
            }
          ]
        });
        console.log('[TikTok Pixel] InitiateCheckout tracked:', params, 'eventID:', eventId);
      }
    },

    /**
     * Track user registration completion
     * @param {object} params - { content_name, status }
     */
    trackCompleteRegistration: function(params) {
      params = params || {};
      var eventId = this._generateEventId('registration', params.user_id);

      // Meta Pixel
      if (typeof fbq === 'function') {
        fbq('track', 'CompleteRegistration', {
          content_name: params.content_name || 'User Signup',
          status: params.status || 'complete'
        }, { eventID: eventId });
        console.log('[Meta Pixel] CompleteRegistration tracked:', params, 'eventID:', eventId);
      }

      // TikTok Pixel
      if (typeof ttq === 'object' && ttq.track) {
        ttq.track('CompleteRegistration', {
          content_name: params.content_name || 'User Signup',
          event_id: eventId
        });
        var submitFormEventId = this._generateEventId('submitform', params.user_id);
        ttq.track('SubmitForm', {
          content_name: params.content_name || 'User Signup',
          event_id: submitFormEventId
        });
        console.log('[TikTok Pixel] CompleteRegistration tracked:', params, 'eventID:', eventId);
      }
    },

    /**
     * Track lead generation (e.g., email signup, contact form)
     * @param {object} params - { content_name, content_category }
     */
    trackLead: function(params) {
      params = params || {};
      var eventId = this._generateEventId('lead', params.content_name);

      // Meta Pixel
      if (typeof fbq === 'function') {
        fbq('track', 'Lead', {
          content_name: params.content_name || 'Lead',
          content_category: params.content_category || 'signup'
        }, { eventID: eventId });
        console.log('[Meta Pixel] Lead tracked:', params, 'eventID:', eventId);
      }

      // TikTok Pixel
      if (typeof ttq === 'object' && ttq.track) {
        ttq.track('SubmitForm', {
          content_name: params.content_name || 'Lead',
          event_id: eventId
        });
        console.log('[TikTok Pixel] Lead tracked:', params, 'eventID:', eventId);
      }
    },

    // Internal: Map Meta event names to TikTok equivalents
    _mapToTikTokEvent: function(metaEvent) {
      var mapping = {
        'ViewContent': 'ViewContent',
        'AddToCart': 'AddToCart',
        'InitiateCheckout': 'InitiateCheckout',
        'Purchase': 'CompletePayment',
        'CompleteRegistration': 'CompleteRegistration',
        'Lead': 'SubmitForm',
        'Search': 'Search',
        'AddPaymentInfo': 'AddPaymentInfo'
      };
      return mapping[metaEvent] || metaEvent;
    },

    // Internal: Map Meta params to TikTok format
    _mapToTikTokParams: function(params) {
      // TikTok uses similar param names, just return as-is
      return params;
    }
  };

  // Expose globally for easy access
  window.trackEvent = window.AmplifyTracking.trackEvent.bind(window.AmplifyTracking);
  window.trackPurchase = window.AmplifyTracking.trackPurchase.bind(window.AmplifyTracking);
  window.trackViewContent = window.AmplifyTracking.trackViewContent.bind(window.AmplifyTracking);
  window.trackInitiateCheckout = window.AmplifyTracking.trackInitiateCheckout.bind(window.AmplifyTracking);
  window.trackCompleteRegistration = window.AmplifyTracking.trackCompleteRegistration.bind(window.AmplifyTracking);
  window.trackLead = window.AmplifyTracking.trackLead.bind(window.AmplifyTracking);
})();
</script>
